---
title: `Figures for the paper- Evaluation of uncertainties in the anthropogenic SO2 emissions in the USA from NASAâ€™s OMI point source catalog`
date: 29th December 2021
authors: Kanishka Narayan & Steven J. Smith
output: 
  pdf_document: default
  word_document: default
  df_print : paged
---

#1. Import libraries
```{r, Get_libraries}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggpmisc)
```

#2. Define constants for isolation analysis
```{r, Define_constants}

d_min <- 15
d_max <- 40
alpha_isol <- 0.1
min_value<- 20
min_reading_from_EIA<- 0

#Define basic scheme for plots
scheme_basic <- theme_bw() +
    theme(legend.text = element_text(size = 12)) +
    theme(legend.title = element_text(size = 12)) +
    theme(axis.text = element_text(size = 11)) +
    theme(axis.title = element_text(size = 11, face = "bold")) +
    theme(plot.title = element_text(size = 12, face = "bold", vjust = 1)) +
    theme(plot.subtitle = element_text(size = 9, face = "bold", vjust = 1))+ 
    theme(strip.text = element_text(size = 7))+
    theme(strip.text.x = element_text(size = 11, face = "bold"))+
    theme(strip.text.y = element_text(size = 11, face = "bold"))+
    theme(legend.position = "bottom")+
    theme(legend.text = element_text(size = 11))+
    theme(legend.title = element_text(size = 11,color = "black",face="bold"))+
    theme(axis.text.x= element_text(angle=60,hjust=1))+
    theme(legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"))



EIA_years <- c(2013,2014,2015,2016,2017)
NEI_years <- c(2008,2011,2014,2017)
EGRIDS_years <- c(2005,2007,2009,2010,2012,2014,2016)

`%notin%` <- Negate(`%in%`)

dir.create("Outputs/",showWarnings = FALSE)
```

#Initial data gathering for isolation analysis
```{r, Initial_Data_Gathering}
#kbn 2020/02/21
#Initial data gathering for isolation analysis
source("OMISO2DataReconciliation.R")
#Compute values using maximum range
EIA_Data_d_max <-
                Get_Consolidated_OMI_Data(source= "EIA", startrange = d_max, endrange = d_max, rangesequence = 0,years=EIA_years) %>%
                  rename(max = ValuefromEIAinKT) %>%
                  dplyr::select(PlantName, Year, max)
#Compute values using minimum range
EIA_Data_d_min <- Get_Consolidated_OMI_Data(source= "EIA", startrange = d_min, endrange = d_min, rangesequence = 0,years=EIA_years) %>%
                  rename(min = ValuefromEIAinKT ) %>%
                  dplyr::select(PlantName, Year, min)

#Get isolation values based on max and min values
EIA_Data_ISOL <- EIA_Data_d_min %>%
                  left_join(EIA_Data_d_max, by =c("PlantName","Year")) %>%
                  mutate(min=if_else(is.na(min),0,min)) %>%
                  mutate(max=if_else(is.na(max),0,max)) %>%
                  mutate(ref=(abs(max)/abs(min))) %>%
                  mutate(m_isolation = if_else((abs(max)/abs(min))<(1+alpha_isol),"Not_isolated","Isolated")) %>%
                  dplyr::select(PlantName, Year, m_isolation)


#Compute values using maximum range
NEI_Data_d_max <- bind_rows(Get_Consolidated_OMI_Data(source= "NEI", startrange = d_max, endrange = d_max, rangesequence = 0,years=NEI_years) %>%
                  rename(max = ValuefromNEIinKT) %>% 
                  dplyr::select(PlantName, Year, max))

#Compute values using minimum range
NEI_Data_d_min <- bind_rows(Get_Consolidated_OMI_Data(source= "NEI", startrange = d_min, endrange = d_min, rangesequence = 0,years=NEI_years) %>% 
                  rename(min = ValuefromNEIinKT ) %>% 
                  dplyr::select(PlantName, Year, min))
                  
#Get isolation values based on max and min values
NEI_Data_ISOL <- NEI_Data_d_min %>% 
                  left_join(NEI_Data_d_max, by =c("PlantName","Year")) %>%
                  mutate(min=if_else(is.na(min),0,min)) %>% 
                  mutate(max=if_else(is.na(max),0,max)) %>%
                  mutate(ref=(abs(max)/abs(min))) %>%   
                  mutate(m_isolation = if_else((abs(max)/abs(min))<(1+alpha_isol),"Not_isolated","Isolated")) %>%     
                  dplyr::select(PlantName, Year, m_isolation)  

EGRIDS_Data_d_max <- bind_rows(Get_Consolidated_OMI_Data(source= "EGRIDS", startrange = d_max, endrange = d_max, rangesequence = 0,years=EGRIDS_years) %>%
                  rename(max = ValuefromEGRIDSinKT) %>% 
                  dplyr::select(PlantName, Year, max))

#Compute values using minimum range
EGRIDS_Data_d_min <- bind_rows(Get_Consolidated_OMI_Data(source= "EGRIDS", startrange = d_min, endrange = d_min, rangesequence = 0,years=EGRIDS_years) %>% 
                  rename(min = ValuefromEGRIDSinKT ) %>% 
                  dplyr::select(PlantName, Year, min))
                  
#Get isolation values based on max and min values
EGRIDS_Data_ISOL <- EGRIDS_Data_d_min %>% 
                  left_join(EGRIDS_Data_d_max, by =c("PlantName","Year")) %>%
                  mutate(min=if_else(is.na(min),0,min)) %>% 
                  mutate(max=if_else(is.na(max),0,max)) %>%
                  mutate(ref=(abs(max)/abs(min))) %>%   
                  mutate(m_isolation = if_else((abs(max)/abs(min))<(1+alpha_isol),"Not_isolated","Isolated")) %>%     
                  dplyr::select(PlantName, Year, m_isolation)



Eia_Data_Mean <- Get_Consolidated_OMI_Data(source= "EIA", startrange = d_max, endrange = d_max, rangesequence = 0,minvalue = 0,years=EIA_years) %>% 
                 inner_join(EIA_Data_ISOL, by= c("PlantName","Year"))

Nei_Data_Mean <- bind_rows(Get_Consolidated_OMI_Data(source= "NEI", startrange = d_max, endrange = d_max, rangesequence = 0,minvalue = 0,years = NEI_years))         %>% 
                 inner_join(NEI_Data_ISOL, by= c("PlantName","Year"))


EGRIDS_Data_Mean <- bind_rows(Get_Consolidated_OMI_Data(source= "EGRIDS", startrange = d_max, endrange = d_max, rangesequence = 0,minvalue = 0,years = EGRIDS_years))         %>% 
                 inner_join(EGRIDS_Data_ISOL, by= c("PlantName","Year"))
```

#Figure 1:Percent error for detected sources for different radii
##Note: The code below only produces the plot for one range. To produce the exact figure as shown in the paper, please add additional ranges to the function- `Get_Consolidated_OMI_Data` in the sections above.
```{r,fig.width=10,fig.height=10}

Eia_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>%  
                   group_by(Range) %>% 
                   mutate(Error_isol= ((mean(Error)))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>%                    select(Range,Error_isol,-reference_col,count,Error) %>%
                   distinct() %>% 
                   mutate(Type ="Percent error",source="1. EIA")->Isol_stats_EIA

Nei_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>% 
                   filter(ValuefromNEIinKT>min_reading_from_EIA) %>%
                   #filter(ValuefromNEIinKT<3200) %>%   
                   filter(Year <= 2014) %>% 
                   group_by(Range) %>% 
                   mutate(Error_isol= (mean(Error))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Error_isol,-reference_col,count,Error) %>%
                   distinct() %>%   
                   mutate(Type ="Percent error",source="3. NEI")->Isol_stats_NEI

EGRIDS_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>% 
                   filter(ValuefromEGRIDSinKT>min_reading_from_EIA) %>%
                   #filter(ValuefromEGRIDSinKT<3200) %>%   
                   filter(Year <= 2014) %>% 
                   group_by(Range) %>% 
                   mutate(Error_isol= mean((Error))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Error_isol,-reference_col,count,Error) %>%
                   distinct() %>%   
                   mutate(Type ="Percent error",source="2. EGRIDS",)->Isol_stats_EGRIDS

g <- ggplot()+
  geom_jitter(data = Isol_stats_EIA %>% bind_rows(Isol_stats_NEI, Isol_stats_EGRIDS), aes(x= Range, y = Error),color="grey",width = 0.1)+
  geom_point(data = Isol_stats_EIA %>% bind_rows(Isol_stats_NEI, Isol_stats_EGRIDS), aes(x= Range, y = Error_isol),color="black",size=3)+
  #scale_x_continuous(breaks = c(unique(c(EGRIDS_years,NEI_years,EIA_years))))+
  ylab("Percent error")+
  ggtitle("Percent error for detected sources for different radii")+
  facet_wrap(~source)

g + scheme_basic
ggsave( paste0('Outputs/Percent error for detected sources for different radii','_R','Alpha_ISOL_',alpha_isol," d_max= ",d_max," d_min= ",d_min,'.png'),width = 12, height = 6 )
```



# Figure 2: Total SO2 emissions detected sources in satellite and inventories
```{r,fig.height=6, fig.width=10}
#Comparison of total emissions

EGRIDS_Data_Mean %>% bind_rows(Eia_Data_Mean %>% filter(Year %notin% c(EGRIDS_years,NEI_years)),Nei_Data_Mean %>% filter(Year %notin% c(EGRIDS_years))) %>%  mutate(Valueplant=Value,source="OMI",count=1) %>% group_by(Range, Year,source) %>% mutate(Error_isol= (sum((Valueplant)))) %>%
                   #mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,count,source) %>%
                   distinct() %>% mutate(Status="1. Detected Emissions",source="EGRIDS (point source database for powerplants)")->OMI_Data

Eia_Data_Mean %>% mutate(source= "EIA") %>% rename(Valueplant= ValuefromEIAinKT) %>% bind_rows(Nei_Data_Mean %>% mutate(source="NEI (Comprehensive point sources)") %>% rename(Valueplant= ValuefromNEIinKT),EGRIDS_Data_Mean %>% mutate(source="EGRIDS (point source database for powerplants)")%>% rename(Valueplant= ValuefromEGRIDSinKT)) %>% select(-ValuefromEIA,-ValuefromNEI, -ValuefromEGRIDS) %>%   na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Valueplant>min_reading_from_EIA) %>%
                   #filter(Valueplant<3200) %>%
                   filter(Status=="Detected") %>% 
                   group_by(Range, Year,source) %>% 
                   mutate(Error_isol= (sum((Valueplant)))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count,source) %>%
                   distinct() %>% mutate(Status="1. Detected Emissions")->Isol_stats_Detected
                   

Eia_Data_Mean %>% mutate(source= "EIA") %>% rename(Valueplant= ValuefromEIAinKT) %>% bind_rows(Nei_Data_Mean %>% mutate(source="NEI (Comprehensive point sources)") %>% rename(Valueplant= ValuefromNEIinKT),EGRIDS_Data_Mean %>% mutate(source="EGRIDS (point source database for powerplants)")%>% rename(Valueplant= ValuefromEGRIDSinKT)) %>% select(-ValuefromEIA,-ValuefromNEI, -ValuefromEGRIDS) %>%   na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Valueplant>min_reading_from_EIA) %>%
                   #filter(Valueplant<3200) %>%
                   filter(Status!="Detected") %>% 
                   group_by(Range, Year,source) %>% 
                   mutate(Error_isol= (sum((Valueplant)))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count,source) %>% distinct() %>% mutate(Status="2. Undetected Emissions")->Isol_stats_Undetected
                   




g<-ggplot(data=bind_rows(Isol_stats_Detected) %>% filter(source != "EIA")  , aes(x=Year,y=Error_isol, color= "inventory")) +
  scale_color_manual(values= c("black", "red"))+
  geom_line()+
  geom_line(data=bind_rows(OMI_Data %>% select(-source))  , aes(x=Year,y=Error_isol, color= "OMI data"), linetype = "solid",show.legend = FALSE)+
  geom_point(show.legend = FALSE)+
  geom_point(data=bind_rows(OMI_Data %>% select(-source))  , aes(x=Year,y=Error_isol, color= "OMI data"),show.legend = FALSE)+
  scale_linetype_manual(values=c("solid","dotted","solid"))+
  ggtitle(paste0("Total SO2 emissions detected sources in satellite and inventories")) +
  ylab("Emissions in kt")+
  ylim(0,NA)+
  labs(subtitle = paste0("Range for source aggregation - ",d_max, " kms"),caption="*Emissions here do not include emissions from Volcanoes")+scale_x_continuous(breaks = c(unique(c(EGRIDS_years,NEI_years,EIA_years))))+
  facet_wrap(~source)
 


g+scheme_basic

ggsave( paste0('Outputs/Comparison of total emissions by isolation for detected sources emissions for undetected sources differentiated by detected and undetected sources','_R','Alpha_ISOL_',alpha_isol," d_max= ",d_max," d_min= ",d_min,'.png'),width = 10, height = 6 )

```

#Figure 3:Errors across years for detected sources (Percent and Total)
```{r,fig.height=6, fig.width=10}

Eia_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>% 
                   #filter(ValuefromEIAinKT>min_reading_from_EIA) %>%
                   #filter(ValuefromEIAinKT<3200) %>%   
                   group_by(Range, Year) %>% 
                   mutate(Error_isol= (sum((Error)))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count) %>%
                   distinct() %>%   
                   mutate(Type = "Total error (in kt)",source="1. EIA",Year= as.integer(Year))->Isol_stats_abs

Nei_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>% 
                   #filter(ValuefromNEIinKT>min_reading_from_EIA) %>%
                   #filter(ValuefromNEIinKT<3200) %>%   
                   group_by(Range, Year) %>% 
                   mutate(Error_isol= (sum((Error)))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count) %>%
                   distinct() %>%   
                   mutate(Type = "Total error (in kt)",Year= as.integer(Year),source="3. NEI")->Isol_stats_NEI_abs

EGRIDS_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>% 
                   #filter(ValuefromEGRIDSinKT>min_reading_from_EIA) %>%
                   #filter(ValuefromEGRIDSinKT<3200) %>%   
                   group_by(Range, Year) %>% 
                   mutate(Error_isol= (sum((Error)))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count) %>%
                   distinct() %>%   
                   mutate(Type = "Total error (in kt)",source="2. EGRIDS",Year= as.integer(Year))->Isol_stats_EGRIDS_abs



Eia_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>% 
                   #filter(ValuefromEIAinKT>min_reading_from_EIA) %>%
                   #filter(ValuefromEIAinKT<3200) %>%   
                   group_by(Range, Year) %>% 
                   mutate(Error_isol= (sum(Error)/sum(ValuefromEIAinKT))*100) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count) %>%
                   distinct() %>% 
                   mutate(Type ="Percent error",source="1. EIA",Year= as.integer(Year))->Isol_stats_percent

Nei_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>% 
                   filter(ValuefromNEIinKT>min_reading_from_EIA) %>%
                   #filter(ValuefromNEIinKT<3200) %>%   
                   group_by(Range, Year) %>% 
                   mutate(Error_isol= (sum(Error)/sum(ValuefromNEIinKT))*100) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count) %>%
                   distinct() %>%   
                   mutate(Type ="Percent error",Year= as.integer(Year),source="3. NEI")->Isol_stats_NEI_percent

EGRIDS_Data_Mean %>%  na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Status=="Detected") %>% 
                   filter(ValuefromEGRIDSinKT>min_reading_from_EIA) %>%
                   #filter(ValuefromEGRIDSinKT<3200) %>%   
                   group_by(Range, Year) %>% 
                   mutate(Error_isol= (sum(Error)/sum(ValuefromEGRIDSinKT))*100) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count) %>%
                   distinct() %>%   
                   mutate(Type ="Percent error",source="2. EGRIDS",Year= as.integer(Year))->Isol_stats_EGRIDS_percent

EGRIDS_Data_Mean %>% filter((Error/ValuefromEGRIDSinKT)<2) %>% filter(Status=="Detected") %>%  na.omit() %>% mutate(Type= "Percent error",value=((Error)/ValuefromEGRIDSinKT)*100,Year= as.integer(Year))-> Jitter_data_percent

EGRIDS_Data_Mean %>% filter((Error/ValuefromEGRIDSinKT)<2) %>% filter(Status=="Detected") %>%  na.omit() %>% mutate(Type= "Total error (in kt)",value=((Error)),Year= as.integer(Year))-> Jitter_data_abs

Nei_Data_Mean %>%  filter((Error/ValuefromNEIinKT)<2) %>% filter(Status=="Detected") %>%  na.omit() %>% mutate(Type= "Percent error",value=((Error)/ValuefromNEIinKT)*100,Year= as.integer(Year))-> Jitter_data_print


g<-ggplot(data=Isol_stats_abs %>% bind_rows(Isol_stats_percent,Isol_stats_EGRIDS_abs,Isol_stats_EGRIDS_percent), aes(x=Year,y=Error_isol)) +
  #geom_line(aes(linetype = source),size=1.1)+
  geom_point(aes(color=source),size=2)+
  scale_color_manual(values = c("light blue","blue","red","grey"))+
  geom_point(data=Isol_stats_NEI_abs %>% bind_rows(Isol_stats_NEI_percent),aes(x=Year,y=Error_isol,fill=source,color=source),size=2,show.legend = FALSE)+
  geom_jitter(data=Jitter_data_abs %>% bind_rows(Jitter_data_percent) ,aes(x=Year,y=value),show.legend = FALSE,size=0.7,width=0.1,color="grey")+
  #geom_text(data=Isol_stats_NEI_abs %>% bind_rows(Isol_stats_NEI_percent),aes(x=Year-0.5,y=Error_isol-7),label= "Error from NEI",size=2,show.legend = FALSE,color="black")+
  ggtitle(paste0("Errors across years for detected sources (Percent and Total)")) +
  ylab("Error")+
  facet_wrap(~Type, scales="free_y") +
  labs(subtitle = paste0("Range for source aggregation - ",d_max, " kms,  grey dots in each year represent point source values from EGRIDS"))+scale_x_continuous(breaks = c(unique(c(EGRIDS_years,NEI_years,EIA_years))))
 


g+scheme_basic

ggsave( paste0('Outputs/Errors (OMI-inventory) across years for detected sources (Percent and unsigned)','_R','Alpha_ISOL_',alpha_isol," d_max= ",d_max," d_min= ",d_min,'.png'),width = 10, height = 6 )

```

#Figure 4:Error statistics vs emissions (in bins) from EGRIDS and NEI
```{r,fig.height=6, fig.width=10}

EGRIDS_Data_Mean %>%
  #First, calculate the error as OMI-EGRIDS
  mutate(Error=Value-ValuefromEGRIDSinKT) %>%
  #Now filter out detected sources
  filter(Status=="Detected") %>%
  #Add selection criteria. Add counts and calculate average emissions
  mutate(Obs=1) %>%
  group_by(PlantName) %>%
  mutate(avg_em= mean(ValuefromEGRIDSinKT),obs_count=sum(Obs)) %>%
  ungroup() %>%
  #Now, let's filter out on the basis of the criteria. Average emissions should be over 20 kt & you should
  #have at least 3 observations
  #filter(avg_em>20) %>%
  #filter(obs_count>=3) %>%
  mutate(Error_percent= (Error/ValuefromEGRIDSinKT)*100) %>% 
  #Now let's calculate the data for the plot
  select(PlantName,Year,Error,Error_percent,ValuefromEGRIDSinKT) %>%
  distinct() %>% 
  mutate(bin = if_else(ValuefromEGRIDSinKT < 10 , "0-10",
                       if_else(ValuefromEGRIDSinKT < 20,"10-20",
                       if_else(ValuefromEGRIDSinKT < 25, "20-25",
                       if_else(ValuefromEGRIDSinKT < 30, "25-30",
                       if_else(ValuefromEGRIDSinKT < 35, "30-35",         
                       if_else(ValuefromEGRIDSinKT < 40, "35-40",        
                       if_else(ValuefromEGRIDSinKT < 60, "40-60",
                               if_else(ValuefromEGRIDSinKT <80, "60-80",
                                       if_else(ValuefromEGRIDSinKT <100, "80-100","Greater than 100")))))))))) %>% 
  mutate(obs =1) %>% 
  group_by(bin) %>% 
  mutate(sd_value = sd(Error_percent), mean_value = mean(Error_percent),count=as.integer(sum(obs))) %>% 
  ungroup() %>% 
  select(bin, sd_value, mean_value, count) %>% 
  distinct() %>% 
  filter(bin != "0-10") %>% 
  mutate(inventory = "1. EGRIDS (point sources for powerplants)")->tmp_EGRIDS
Nei_Data_Mean %>%
  #First, calculate the error as OMI-EGRIDS
  mutate(Error=Value-ValuefromNEIinKT) %>%
  #Now filter out detected sources
  filter(Status=="Detected") %>%
  #Add selection criteria. Add counts and calculate average emissions
  mutate(Obs=1) %>%
  group_by(PlantName) %>%
  mutate(avg_em= mean(ValuefromNEIinKT),obs_count=sum(Obs)) %>%
  ungroup() %>%
  #Now, let's filter out on the basis of the criteria. Average emissions should be over 20 kt & you should
  #have at least 3 observations
  #filter(avg_em>20) %>%
  #filter(obs_count>=3) %>%
  mutate(Error_percent= (Error/ValuefromNEIinKT)*100) %>% 
  #Now let's calculate the data for the plot
  select(PlantName,Year,Error,Error_percent,ValuefromNEIinKT) %>%
  distinct() %>% 
  mutate(bin = if_else(ValuefromNEIinKT < 10 , "0-10",
                       if_else(ValuefromNEIinKT < 20,"10-20",
                       if_else(ValuefromNEIinKT < 25, "20-25",
                       if_else(ValuefromNEIinKT < 30, "25-30",
                       if_else(ValuefromNEIinKT < 35, "30-35",         
                       if_else(ValuefromNEIinKT < 40, "35-40",        
                       if_else(ValuefromNEIinKT < 60, "40-60",
                               if_else(ValuefromNEIinKT <80, "60-80",
                                       if_else(ValuefromNEIinKT <100, "80-100","Greater than 100")))))))))) %>% 
  mutate(obs=1) %>% 
  group_by(bin) %>% 
  mutate(sd_value = sd(Error_percent), mean_value = mean(Error_percent),count=as.integer(sum(obs))) %>% 
  ungroup() %>% 
  select(bin, sd_value, mean_value,count) %>% 
  distinct() %>% 
  filter(bin != "0-10") %>% 
  mutate(inventory= "2. NEI (Comprehensive point sources)")->tmp_NEI

g <- ggplot(data= tmp_EGRIDS %>% bind_rows(tmp_NEI), aes(x=bin, y=sd_value, color=inventory))+
     geom_point(aes(shape="standard deviation",color= inventory),size=8)+
     geom_text(aes(x=bin,y=sd_value*1.25,label=paste0(count)),color="black")+
     scale_shape_manual(values = c(16, 45))+
     scale_color_manual(values = c("blue", "red"))+
     geom_point(data=tmp_EGRIDS%>% bind_rows(tmp_NEI), aes(x=bin, y= mean_value, shape="mean",color= inventory),size=3)+
     ggtitle("Error statistics vs emissions (in bins) from EGRIDS and NEI")+
   ylab("Percent error")+facet_wrap(~inventory)+xlab("Size of emissions in kt")+
   labs(subtitle = "Observations with emissions under 10 kt are not included. Numbers represent count of detected sources (n) in all years")

g+scheme_basic
ggsave( paste0('Outputs/Error statistics vs emissions (in bins) from EGRIDS and NEI','.png'),width = 12, height = 6 )
```

#Figure 5: Error over time (OMI - EGRIDS) in kt  by Plant
```{r,fig.width=10,fig.height=6}

Eia_Data_Mean %>%
  #filter(ValuefromEIAinKT >= 30) %>% 
  #First, calculate the error as OMI-EIA
  mutate(Error=Value-ValuefromEIAinKT) %>%
  #Now filter out detected sources
  filter(Status=="Detected") %>%
  #Add selection criteria. Add counts and calculate average emissions
  mutate(Obs=1) %>%
  group_by(PlantName) %>%
  mutate(avg_em= mean(ValuefromEIAinKT),obs_count=sum(Obs)) %>%
  ungroup() %>%
  #Now, let's filter out on the basis of the criteria. Average emissions should be over 20 kt & you should
  #have at least 3 observations
  #filter(avg_em>20) %>%
  #filter(obs_count>=3) %>%
  mutate(Error_percent= (Error/ValuefromEIAinKT)*100) %>% 
  #Now let's calculate the data for the plot
  select(PlantName,Year,Error,Error_percent,ValuefromEIAinKT,obs_count) %>%
  distinct()->tmp

tmp %>% 
  group_by(Year) %>% 
  mutate(Error= (sum(Error))) %>% 
  ungroup() %>% 
  mutate(PlantName ="Total")->tmp_total


EGRIDS_Data_Mean %>%
  #filter(ValuefromEGRIDSinKT >= 30) %>% 
  #First, calculate the error as OMI-EGRIDS
  #filter(ValuefromEGRIDSinKT >=40) %>% 
  mutate(Error=Value-ValuefromEGRIDSinKT) %>%
  #Now filter out detected sources
  filter(Status=="Detected") %>%
  #Add selection criteria. Add counts and calculate average emissions
  mutate(Obs=1) %>%
  group_by(PlantName) %>%
  mutate(avg_em= mean(ValuefromEGRIDSinKT),obs_count=sum(Obs)) %>%
  ungroup() %>%
  #Now, let's filter out on the basis of the criteria. Average emissions should be over 20 kt & you should
  #have at least 3 observations
  #filter(avg_em>20) %>%
  #filter(obs_count>=3) %>%
  mutate(Error_percent= (Error/ValuefromEGRIDSinKT)*100) %>% 
  #Now let's calculate the data for the plot
  select(PlantName,Year,Error,Error_percent,ValuefromEGRIDSinKT,obs_count) %>%
  distinct()->tmp_EGRIDS

tmp_EGRIDS %>% 
  group_by(Year) %>% 
  mutate(Error= (sum(Error))) %>% 
  ungroup() %>% 
  
  mutate(PlantName ="Total")->tmp_total_EGRIDS
tmp_EGRIDS %>% filter(PlantName %in% c("Shawnee", "Mitchell"))->tmp_EGRIDS

Nei_Data_Mean %>%
  #filter(ValuefromNEIinKT >= 30) %>% 
  #First, calculate the error as OMI-EIA
  mutate(Error=Value-ValuefromNEIinKT) %>%
  distinct() %>%
  filter(Status=="Detected") %>% 
  #Now filter out detected sources
  #filter(Status=="Detected") %>%
  #Add selection criteria. Add counts and calculate average emissions
  mutate(Obs=1) %>%
  group_by(PlantName) %>% 
  mutate(avg_em= mean(ValuefromNEIinKT),obs_count=sum(Obs)) %>% 
  ungroup() %>% 
  group_by(PlantName, Year) %>%
  mutate(Error= sum(Error)) %>%
  ungroup() %>%
  #Now, let's filter out on the basis of the criteria. Average emissions should be over 20 kt & you should
  #have at least 3 observations
  #filter(PlantName %in% c(unique(tmp$PlantName))) %>%
  #Now let's calculate the data for the plot
  #filter(obs_count > 3) %>% 
  select(PlantName,Year,Error,ValuefromNEIinKT,obs_count) %>%
  mutate(Error_percent= (Error/ValuefromNEIinKT)*100) %>% 
  distinct()->tmpNEI


tmpNEI %>% 
  group_by(Year) %>% 
  mutate(Error= (sum(Error))) %>% 
  ungroup() %>% 
  mutate(PlantName ="Total")->tmp_NEI_total

g<- ggplot(data=tmp_EGRIDS  ,aes(x=Year,y=Error))+
    #geom_line()+
    geom_line(data=tmp_EGRIDS  ,aes(x=Year,y=Error),linetype="dashed")+
    geom_point(data=tmp_EGRIDS  ,aes(x=Year,y=Error),color="red")+
    #geom_point()+
    #geom_point(data=tmpNEI %>%  bind_rows(tmp_NEI_total),aes(x=Year,y=Error),size=3,color="blue",show.legend = FALSE)+
    #geom_text(data=tmpNEI,aes(x=Year,y=Error-2),label= "NEI",size=2,show.legend = FALSE,color="black")+
    #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    ylab("Error in kt")+
    xlab("Year")+
    ggtitle(" Error over time (OMI - EGRIDS) in kt  by Plant")+
    facet_wrap(~PlantName)+
    scale_x_continuous(breaks= c(unique(EGRIDS_years,EIA_years,NEI_years)))


g+scheme_basic
ggsave( paste0('Outputs/Error_Analysis_by_plant_over_time_free_scales_total error','.png'),width = 6, height = 4 )

```


#Figure 6:Size of bias (mean percent error) and Direction of bias (over vs underestimation) for detected sources"
```{r,fig.height=6,fig.width=10}


Nei_Data_Mean %>%
  #filter(ValuefromNEIinKT >= 30) %>% 
  #First, calculate the error as OMI-EGRIDS
  #filter(ValuefromEGRIDSinKT >=40) %>% 
  mutate(Error=Value-ValuefromNEIinKT) %>%
  #Now filter out detected sources
  filter(Status=="Detected") %>%
  #Add selection criteria. Add counts and calculate average emissions
  mutate(Obs=1) %>%
  group_by(PlantName) %>%
  mutate(avg_em= mean(ValuefromNEIinKT),obs_count=sum(Obs),Error=mean(Error)) %>%
  ungroup() %>%
  #Now, let's filter out on the basis of the criteria. Average emissions should be over 20 kt & you should
  #have at least 3 observations
  #filter(avg_em>20) %>%
  filter(obs_count>=3) %>%
  mutate(Error_percent= (Error/avg_em)*100, source="NEI",Valueplant = ValuefromNEIinKT) %>% 
  #Now let's calculate the data for the plot
  select(PlantName,Year,Error,Error_percent,source) %>%
  distinct()->tmp_NEI


Nei_Data_Mean %>% 
  select(PlantName,Year,ValuefromNEIinKT,Value,Status) %>% 
  
  #bind_rows(Nei_Interpolated) %>%
  distinct() %>%   
  filter(Status=="Detected") %>%   
  mutate(Obs=1) %>%
  #First, calculate the error as OMI-EIA
  #filter(ValuefromNEIinKT > 30) %>% 
  mutate(Error=Value-ValuefromNEIinKT) %>% 
  #Now filter out detected sources
  group_by(PlantName) %>% 
  mutate(Average_Emissions_KT=mean(ValuefromNEIinKT)) %>%
  ungroup() %>%
  filter(PlantName %in% c(unique(tmp_NEI$PlantName))) %>% 
  group_by(PlantName) %>% 
  mutate(Error_Term=sum(Error)/sum(abs(Error)),
         count = sum(Obs)) %>% 
  ungroup() %>% 
  select(PlantName,Error_Term,Average_Emissions_KT,count) %>%
  #left_join(tmp %>% select(PlantName,AverageEIAValue),by=c("PlantName")) %>% 
  distinct() %>%
  filter(count >= 3) %>% 
  mutate(source=paste0("NEI"))->tmp_NEI_direction


tmp_NEI %>% left_join((tmp_NEI_direction), by= c("PlantName","source")) %>%
  na.omit() %>% mutate(source = "NEI (Comprehensive point sources)")->plot_data

g <- ggplot(data=plot_data %>% filter(source == "NEI (Comprehensive point sources)"), aes(x=Error_Term, y=Error_percent, color=source))+
     geom_point(aes(size=Average_Emissions_KT),color="red")+
     facet_wrap(~source)+
     geom_smooth(method = "glm", formula = "y ~ x", se = FALSE, color= "black", linetype = "dashed")+
     xlab("Direction score* (Direction of bias over time)")+
     ylab("Mean percent error over time (Size of bias over time)")+
     ggtitle("Size of bias (mean percent error) and Direction of bias (over vs underestimation) for detected sources")+
     labs(caption = "*Direction score is the sum of Error (OMI-Inventory) divided by the sum of the absolute error by Plant. Direction score of 1 indicates consistent over estimate from OMI over time.")


g+scheme_basic
ggsave( paste0('Outputs/Size of bias (mean percent error) and Direction of bias (over vs underestimation) for detected sources','.png'),width = 10, height = 6 )
```

# Figure 7:Density plot of percent error for all detected sources in the NEI inventory
```{r,fig.width=10,fig.height=6}
Nei_Data_Mean %>%
  mutate(Error=Value-ValuefromNEIinKT) %>%
  #Now filter out detected sources
  filter(Status=="Detected") %>%
  #Add selection criteria. Add counts and calculate average emissions
  mutate(Obs=1) %>%
  group_by(PlantName) %>% 
  mutate(obs_count=sum(Obs)) %>% 
  ungroup() %>% 
  group_by(PlantName) %>%
  mutate(avg_em= mean(ValuefromNEIinKT),Error=mean(Error)) %>%
  ungroup() %>%
  #Now, let's filter out on the basis of the criteria. Average emissions should be over 20 kt & you should
  #have at least 3 observations
  #filter(avg_em>20) %>%
  filter(obs_count>=3) %>%
  mutate(Error_percent= (Error/avg_em)*100, source="NEI",Valueplant = ValuefromNEIinKT) %>% 
  #Now let's calculate the data for the plot
  select(PlantName,Error,Error_percent,source) %>%
  distinct()->tmp_NEI


tmp_NEI %>%  distinct() ->plot_data
x <- seq(min(plot_data$Error_percent), max(plot_data$Error_percent), length.out=56)


m <- mean(plot_data$Error_percent)
s <- sd(plot_data$Error_percent)
location <- log(m^2 / sqrt(s^2 + m^2))
shape <- sqrt(log(1 + (s^2 / m^2)))

draws3 <- dnorm(seq(-150, 150, length.out=56), 0, s)
draw_d <- as.data.frame(draws3)  %>% 
          mutate(Error_percent = seq(-150, 150, length.out=56)) %>% 
          rename(density = draws3 )

g <- ggplot()+
     geom_histogram(data= plot_data, aes(x=Error_percent, y = ..density..),fill = "white",color="black", bins = 20)+
  geom_density(data= plot_data, aes(x=Error_percent, y = ..density..),color="red", size = 1.2)+
  geom_line(data= draw_d, aes(x=Error_percent, y=density),color="blue", linetype = "dashed", size = 1.2)+
  xlab("Mean percent error")+
  xlim(-150,300)+
  ggtitle("Density plot of percent error for all detected sources in the NEI inventory")+
  labs(subtitle = "Bars are the actual density of the error. The red line is a smoothed density curve")
g+scheme_basic

ggsave( paste0('Outputs/Density plot of percent error for all detected sources in the NEI inventory','.png'),width = 10, height = 6 )
```

# Figure 8: Total SO2 emissions for inventories in USA
```{r,fig.height=6, fig.width=10}
#Comparison of total emissions

EGRIDS_Data_Mean %>% bind_rows(Eia_Data_Mean %>% filter(Year %notin% c(EGRIDS_years,NEI_years)),Nei_Data_Mean %>% filter(Year %notin% c(EGRIDS_years))) %>%  mutate(Valueplant=Value,source="OMI",count=1) %>% group_by(Range, Year,source) %>% mutate(Error_isol= (sum((Valueplant)))) %>%
                   #mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,count,source) %>%
                   distinct() %>% mutate(Status="3. OMI Value")->OMI_Data

Eia_Data_Mean %>% mutate(source= "EIA (CEMS powerplants)") %>% rename(Valueplant= ValuefromEIAinKT) %>% bind_rows(Nei_Data_Mean %>% mutate(source="NEI (Comprehensive point sources)") %>% rename(Valueplant= ValuefromNEIinKT),EGRIDS_Data_Mean %>% mutate(source="EGRIDS (powerplant point sources)")%>% rename(Valueplant= ValuefromEGRIDSinKT)) %>% select(-ValuefromEIA,-ValuefromNEI, -ValuefromEGRIDS) %>%   na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Valueplant>min_reading_from_EIA) %>%
                   #filter(Valueplant<3200) %>%
                   #filter(Status=="Detected") %>% 
                   group_by(Range, Year,source) %>% 
                   mutate(Error_isol= (sum((Valueplant)))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count,source) %>%
                   distinct() %>% mutate(Status="1. Detected by satellite")->Isol_stats_Detected
                   

Eia_Data_Mean %>% mutate(source= "EIA (CEMS powerplants)") %>% rename(Valueplant= ValuefromEIAinKT) %>% bind_rows(Nei_Data_Mean %>% mutate(source="NEI (Comprehensive point sources)") %>% rename(Valueplant= ValuefromNEIinKT),EGRIDS_Data_Mean %>% mutate(source="EGRIDS (powerplant point sources)")%>% rename(Valueplant= ValuefromEGRIDSinKT)) %>% select(-ValuefromEIA,-ValuefromNEI, -ValuefromEGRIDS) %>%   na.omit() %>% 
                   mutate(reference_col =1) %>% 
                   filter(PlantName != "Partially Reporting Facilities") %>%
                   filter(Valueplant>min_reading_from_EIA) %>%
                   #filter(Valueplant<3200) %>%
                   filter(Status!="Detected") %>% 
                   group_by(Range, Year,source) %>% 
                   mutate(Error_isol= (sum((Valueplant)))) %>%
                   mutate(count=sum(reference_col)) %>% 
                   ungroup() %>% 
                   select(Range,Year,Error_isol,-reference_col,count,source) %>% distinct() %>% mutate(Status="2. Undetected by satellite")->Isol_stats_Undetected
                   




g<-ggplot(data=bind_rows(Isol_stats_Detected, Isol_stats_Undetected) , aes(x=Year,y=Error_isol,linetype = Status)) +
  geom_line()+
  geom_point()+
  ggtitle(paste0("Total SO2 emissions for inventories in USA")) +
  scale_color_manual (values = c("black"))+
  ylab("Emissions in kt")+
  ylim(0,NA)+
  labs(subtitle = paste0("Range for source aggregation - ",d_max, " kms"),caption="*Emissions here do not include emissions from Volcanoes")+scale_x_continuous(breaks = c(unique(c(EGRIDS_years,NEI_years,EIA_years))))+
  facet_wrap(~source)
 


g+scheme_basic

ggsave( paste0('Outputs/Comparison of total emissions by isolation for detected sources emissions for undetected sources','_R','Alpha_ISOL_',alpha_isol," d_max= ",d_max," d_min= ",d_min,'.png'),width = 10, height = 6 )
```

# Figure 9:Distribution of emissions for sources by detection status* for all years for the NEI
```{r,fig.width=10,fig.height=6}
Nei_Data_Mean %>% 
  mutate(Status = if_else(Status !="Detected", "Undetected by satellite", "Detected by satellite")) %>% 
  mutate(bin = if_else(ValuefromNEIinKT < 5 , "0-5",
                       if_else(ValuefromNEIinKT < 10 , "5-10",
                       if_else(ValuefromNEIinKT < 20,"10-20",
                       if_else(ValuefromNEIinKT < 25, "20-25",
                       if_else(ValuefromNEIinKT < 30, "25-30",
                       if_else(ValuefromNEIinKT < 35, "30-35",         
                       if_else(ValuefromNEIinKT < 40, "35-40",        
                       if_else(ValuefromNEIinKT < 60, "40-60",
                               if_else(ValuefromNEIinKT <80, "60-80",
                                       if_else(ValuefromNEIinKT <100, "80-100","Greater than 100"))))))))))) %>% 
  arrange(ValuefromNEIinKT)->t

t$bin <- factor(t$bin, levels = c("0-5","5-10","10-20","20-25",
                                  "25-30", "30-35","35-40","40-60",
                                  "60-80","80-100","Greater than 100"))

g <- ggplot(data =t %>% filter(bin != "0-5"), aes(x=bin, fill=Status))+
     geom_histogram(bins=30, color="black", stat="count", binwidth = 1)+
     ggtitle("Distribution of emissions for sources by detection status* for all years for the NEI")+
  labs(caption="*Radius for aggregation used here in 40 kms" )+
  ylab("Count")+
  xlab("Annual emissions in kt")
  

g +scheme_basic

ggsave( paste0('Outputs/Histogram of detections','_R','Alpha_ISOL_',alpha_isol," d_max= ",d_max," d_min= ",d_min,'.png'),width = 10, height = 6 )
```




